<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lieferoptimierung</title>
    <link rel="stylesheet" href="static/styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Lieferrouten-Optimierung</h1>
        </header>

        <main>
            <div class="content-wrapper">
                <div class="sidebar">
                    <section class="control-panel">
                        <h2>Steuerung</h2>
                        <button id="optimizeBtn" class="primary-btn">Routen optimieren</button>
                        <div id="loadingIndicator" class="loading-indicator hidden">
                            Berechne optimale Routen...
                        </div>
                    </section>

                    <section class="route-list">
                        <h2>Optimierte Routen</h2>
                        <div id="routeResults">
                            <!-- Route results will be inserted here -->
                        </div>
                    </section>
                </div>

                <div class="map-container">
                    <div id="map"></div>
                </div>
            </div>
        </main>

        <footer>
            <p>&copy; 2024 Lieferoptimierung</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize map
            const map = L.map('map').setView([52.52, 13.405], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            let markers = [];
            let routeLines = [];

            // Handle optimize button click
            document.getElementById('optimizeBtn').addEventListener('click', async function() {
                const loadingIndicator = document.getElementById('loadingIndicator');
                const routeResults = document.getElementById('routeResults');

                loadingIndicator.classList.remove('hidden');
                routeResults.innerHTML = '';

                // Clear previous markers and routes
                markers.forEach(marker => map.removeLayer(marker));
                routeLines.forEach(line => map.removeLayer(line));
                markers = [];
                routeLines = [];

                try {
                    const response = await fetch('/optimize');
                    const data = await response.json();

                    if (data.success) {
                        data.routes.forEach((route, routeIndex) => {
                            // Create route display element
                            const routeElement = document.createElement('div');
                            routeElement.className = 'route-item';
                            routeElement.innerHTML = `<h3>Route ${routeIndex + 1}</h3>`;

                            const stopList = document.createElement('ul');
                            const routeCoordinates = [];

                            route.forEach((stop, stopIndex) => {
                                // Add stop to list
                                const stopItem = document.createElement('li');
                                stopItem.textContent = `${stop.address} (${stop.arrival_time} - ${stop.departure_time})`;
                                stopList.appendChild(stopItem);

                                // Add marker to map
                                const marker = L.marker([stop.coordinates[0], stop.coordinates[1]])
                                    .bindPopup(`Stop ${stopIndex + 1}: ${stop.address}<br>Arrival: ${stop.arrival_time}`);
                                markers.push(marker);
                                marker.addTo(map);

                                routeCoordinates.push([stop.coordinates[0], stop.coordinates[1]]);
                            });

                            // Draw route line
                            const routeLine = L.polyline(routeCoordinates, {
                                color: `hsl(${360 * (routeIndex / data.routes.length)}, 70%, 50%)`,
                                weight: 3,
                                opacity: 0.7
                            });
                            routeLines.push(routeLine);
                            routeLine.addTo(map);

                            routeElement.appendChild(stopList);
                            routeResults.appendChild(routeElement);
                        });

                        // Fit map bounds to show all markers
                        if (markers.length > 0) {
                            const group = new L.featureGroup(markers);
                            map.fitBounds(group.getBounds().pad(0.1));
                        }
                    } else {
                        routeResults.innerHTML = '<p class="error">Keine LÃ¶sung gefunden</p>';
                    }
                } catch (error) {
                    routeResults.innerHTML = '<p class="error">Fehler bei der Routenoptimierung</p>';
                    console.error('Error:', error);
                }

                loadingIndicator.classList.add('hidden');
            });
        });
    </script>
</body>
</html>