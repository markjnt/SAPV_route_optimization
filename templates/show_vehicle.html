<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Mitarbeiterliste</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="show-page-container">
        <div class="back-link">
            <a href="{{ url_for('upload_file') }}">← Zurück zum Upload</a>
        </div>

        <h1>Mitarbeiterliste</h1>

        {% if vehicles %}
        <div class="vehicle-controls">
            <button onclick="toggleAllVehicles(true)">Alle auswählen</button>
            <button onclick="toggleAllVehicles(false)">Alle abwählen</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Aktiv</th>
                    <th>Nr.</th>
                    <th>Name</th>
                    <th>Funktion</th>
                    <th>Startadresse</th>
                    <th>Stellenumfang</th>
                </tr>
            </thead>
            <tbody>
                {% for vehicle in vehicles %}
                <tr>
                    <td>
                        <input type="checkbox" 
                               class="vehicle-checkbox" 
                               data-vehicle-id="{{ vehicle.id }}"
                               onchange="updateVehicleSelection(this)"
                               {% if vehicle.is_active %}checked{% endif %}>
                    </td>
                    <td>{{ vehicle.id }}</td>
                    <td>{{ vehicle.name }}</td>
                    <td>
                        <span class="funktion-line {% if vehicle.funktion == 'Arzt' %}arzt
                            {% elif vehicle.funktion == 'Pflegekraft' %}pflege
                            {% elif vehicle.funktion.startswith('Honorararzt') %}honorar
                            {% endif %}">
                            {{ vehicle.funktion }}
                        </span>
                    </td>
                    <td>{{ vehicle.start_address }}</td>
                    <td>{{ vehicle.stellenumfang }} %</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>Keine Fahrzeuge gefunden.</p>
        {% endif %}
    </div>

    <script>
        function updateVehicleSelection(checkbox) {
            const vehicleId = parseInt(checkbox.dataset.vehicleId);
            const isActive = checkbox.checked;
            
            fetch('/update_vehicle_selection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    vehicles: [{
                        id: vehicleId,
                        active: isActive
                    }]
                })
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Fehler beim Speichern der Auswahl.');
                // Bei Fehler Checkbox auf vorherigen Zustand zurücksetzen
                checkbox.checked = !isActive;
            });
        }

        function toggleAllVehicles(checked) {
            const checkboxes = document.querySelectorAll('.vehicle-checkbox');
            const updates = [];
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = checked;
                updates.push({
                    id: parseInt(checkbox.dataset.vehicleId),
                    active: checked
                });
            });

            fetch('/update_vehicle_selection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ vehicles: updates })
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Fehler beim Speichern der Auswahl.');
                // Bei Fehler Checkboxen auf vorherigen Zustand zurücksetzen
                checkboxes.forEach(checkbox => checkbox.checked = !checked);
            });
        }
    </script>
</body>
</html>